name: Build and Release

on:
  push:
    branches:
      - master
    tags:
      - 'v*'

env:
  DOTNET_VERSION: '3.1.x'
  PROJECT_PATH: 'ComputerHardwareInfo/ComputerHardwareInfo.csproj'
  OUTPUT_NAME: 'HardwareCollector'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup .NET Framework
      uses: microsoft/setup-msbuild@v1
      with:
        vswhere-path: 'C:\Program Files (x86)\Microsoft Visual Studio\Installer'

    - name: Restore NuGet packages
      run: nuget restore "${{ env.PROJECT_PATH }}"

    - name: Build Release
      run: msbuild "${{ env.PROJECT_PATH }}" /p:Configuration=Release /p:Platform="Any CPU"

    - name: Get version
      id: version
      shell: powershell
      run: |
        $version = if ($env:GITHUB_REF -like 'refs/tags/v*') {
          $env:GITHUB_REF -replace 'refs/tags/v', ''
        } else {
          $date = Get-Date -Format 'yyyyMMdd'
          $run = $env:GITHUB_RUN_NUMBER
          "0.1.$run-$date"
        }
        echo "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

    - name: Create Release Directory
      run: |
        mkdir release_output
        copy "ComputerHardwareInfo\bin\Release\HardwareCollector.exe" release_output\
        copy "ComputerHardwareInfo\bin\Release\*.dll" release_output\

    - name: Create ZIP archive
      shell: powershell
      run: |
        Compress-Archive -Path release_output\* -DestinationPath "HardwareCollector-${{ steps.version.outputs.version }}.zip"

    - name: Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.version.outputs.version }}
        release_name: Release ${{ steps.version.outputs.version }}
        body: |
          ## HardwareCollector v${{ steps.version.outputs.version }}
          
          This is an automated release build.
          
          ### What's included:
          - HardwareCollector.exe - Main application
          - Required .NET Framework dependencies
          
          ### Requirements:
          - Windows OS
          - .NET Framework 4.0 or higher
          
          ### Usage:
          ```
          HardwareCollector.exe server01 server02
          HardwareCollector.exe "server01,server02,server03"
          HardwareCollector.exe /?
          ```
          
          For more information, see the [repository](https://github.com/${{ github.repository }})
        draft: false
        prerelease: false
      id: create_release

    - name: Upload Release Asset (ZIP)
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./HardwareCollector-${{ steps.version.outputs.version }}.zip
        asset_name: HardwareCollector-${{ steps.version.outputs.version }}.zip
        asset_content_type: application/zip

    - name: Upload Release Asset (EXE)
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release_output/HardwareCollector.exe
        asset_name: HardwareCollector-${{ steps.version.outputs.version }}.exe
        asset_content_type: application/octet-stream
